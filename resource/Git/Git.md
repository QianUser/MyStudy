# 概述

## 版本控制

版本控制是一种记录文件内容变化，以便将来查阅特定版本修订情况的系统。

版本控制最重要的是可以记录文件修改历史记录，从而让用户能够查看历史版本、方便版本切换。

需要版本控制的原因在于：

- 从个人角度来看：记录开发的历史状态。


- 从团队角度来看：允许多人协同开发相关内容。


### 版本控制工具

版本控制工具应该具备以下功能：

- 协同修改：多人并行不悖地修改服务器端的同一文件。
- 数据备份：不仅保存目录与文件的当前状态，还能够保存每一个提交过的历史状态。
- 版本管理：保存每个版本的文件信息要做到不保存重复数据，以节省存储空间，提高运行效率。这方面SVN采用的是增量式管理的方式，而Git采取了文件系统快照的方式。
- 权限控制：对团队中参与开发的人员进行权限控制；对团队外开发者贡献的代码进行审核（后者是Git独有的）。
- 历史记录：查看修改人、修改时间、修改内容、日志信息等；可以将本地文件恢复到某一个历史状态。
- 分支管理：允许开发团队在工作过程中多条生产线同时推进任务，进一步提高效率。

版本控制工具有两大类：

- 集中式版本控制工具：开发人员是客户端，文件与版本信息存储在服务器中，容易出现单点故障。如CVS、SVN、VSS。
- 分布式版本控制工具：在本地进行版本控制，可避免单点故障。但实践中，实现通常需要一个远程库。如Git、Mercurial、Bazaar、Darcs。

#### 集中式版本控制工具

集中化的版本控制系统都有一个单一的集中管理的服务器，保存所有文件的修订版本，而协同工作的人们都通过客户端连到这台服务器，取出最新的文件或者提交更新。多年以来，这已成为版本控制系统的标准做法。

这种做法带来了许多好处，每个人都可以在一定程度上看到项目中的其他人正在做些什么。而管理员也可以轻松掌控每个开发者的权限，并且管理一个集中化的版本控制系统，要远比在各个客户端上维护本地数据库来得轻松容易。

这么做显而易见的缺点是中央服务器的单点故障。如果服务器宕机一小时，那么在这一小时内，谁都无法提交更新，也就无法协同工作。

#### 分布式版本控制工具

像Git这种分布式版本控制工具，客户端提取的不是最新版本的文件快照，而是把代码仓库完整地镜像下来（本地库）。这样任何一处协同工作用的文件发生故障，事后都可以用其他客户端的本地仓库进行恢复。因为每个客户端的每一次文件提取操作，实际上都是一次对整个文件仓库的完整备份。

分布式的版本控制系统出现之后,解决了集中式版本控制系统的缺陷:

- 服务器断网的情况下也可以进行开发（因为版本控制是在本地进行的）。
- 每个客户端保存的也都是整个完整的项目（包含历史记录，更加安全）。

## Git

[Git](https://git-scm.com/)是一个免费的、开源的分布式版本控制系统，可以快速高效地处理从小型到大型的各种项目。

Git易于学习、占用内存小、性能极高。 它具有廉价的本地分支、方便的暂存区域和多工作流等特性，其性能优于Subversion、CVS、Perforce和ClearCase 等版本控制工具。

Git的优势：

- 大部分操作在本地完成，不需要联网。
- 完整性保证：对提交数据进行哈希操作。
- 尽可能添加数据而不是删除或修改数据，因此很少有不可逆的操作。
- 分支操作非常快捷流畅（因为采取了文件系统快照的方式进行版本管理）。
- 与Linux命令全面兼容。

### Git简史[^3]

同生活中的许多伟大事物一样，Git 诞生于一个极富纷争大举创新的年代。
Linus在1991年创建了开源的Linux，从此，Linux系统不断发展，已经成为最大的服务器系统软件了。在1991-2002年期间，世界各地的志愿者把源代码文件通过diff的方式发给Linus，然后由Linus本人通过手工方式合并代码。

Linus之所以不把Linux代码放到版本控制系统里，是因为尽管当时有CVS、SVN等免费的版本控制系统，但是Linus坚定地反对CVS和SVN，这些集中式的版本控制系统不但速度慢，而且必须联网才能使用；有一些商用的版本控制系统，虽然比CVS、SVN好用，但那是付费的，和Linux的开源精神不符。
到2002年，Linux系统已经发展了十年了，代码库之大让Linus很难继续通过手工方式管理了，整个项目组开始启用一个专有的分布式版本控制系统BitKeeper来管理和维护代码，BitKeeper的东家BitMover公司也免费授权Linux社区使用这个版本控制系统。后来BitMover公司发现社区有人试图破解BitKeeper的协议，于是 BitMover公司收回了Linux社区的免费使用权。

这就迫使Linux开源社区（特别是Linux的缔造者Linus Torvalds）基于使用BitKeeper时的经验教训，开发出自己的版本系统。 他们对新的系统制订了若干目标：

- 速度。

- 简单的设计。
- 对非线性开发模式的强力支持（允许成千上万个并行开发的分支）。
- 完全分布式。
- 有能力高效管理类似Linux内核一样的超大规模项目（速度和数据量）。

于是，Linus花了两周时间自己用C写了一个分布式版本控制系统，这就是Git。一个月之内，Linux系统的源码已经由 Git 管理了。

自2005年诞生以来，Git日臻成熟完善，在高度易用的同时，仍然保留着初期设定的目标。它的速度飞快，极其适合管理大项目，有着令人难以置信的非线性分支管理系统。Git迅速成为最流行的分布式版本控制系统，尤其是2008年，GitHub 网站上线了，它为开源项目免费提供Git存储，无数开源项目开始迁移至GitHub，包括jQuery、PHP、Ruby等等。

### Git的工作机制

Git的本地结构如下：

- 工作区（Working Tree）：写代码的地方。
- 暂存区（Index/Stage）：打算提交但未提交代码的地方，用于临时存储代码。工作区中的内容通过`git add`命令进入暂存区。
- 本地库（Repository）：存储历史版本的地方。暂存区中的内容通过`git commit`进入本地库。

## 代码托管中心

代码托管中心是基于网络服务器的远程代码仓库，一般简单称为远程库，主要分为两类：

- 基于局域网的代码托管中心，如[GitLab](https://about.gitlab.com/)，安装说明见https://about.gitlab.cn/install/。
- 基于互联网的代码托管中心，如[GitHub](https://github.com/)（位于外网）、码云（[Gitee](https://gitee.com/)，是国内网站）。GitHub服务器在国外，使用GitHub作为项目托管网站，如果网速不好，会严重影响使用体验，甚至会出现登录不上的情况。此时可以使用国内的项目托管网站码云，它是开源中国推出的基于 Git 的代码托管服务中心 ，使用方式跟GitHub几乎一样，而且它是一个中文网站。GitHub同时支持导入并同步仓库操作（例如导入GitHub仓库，当GitHub仓库更新后，可以强制同步GitHub仓库）。

# Git常用命令

## 设置用户签名

签名包括用户名与邮箱，它的作用是区分不同操作者身份。用户的签名信息在每一个版本的提交信息中能够看到，以此确认本次提交是谁做的。Git 首次安装必须设置一下用户签名，否则无法提交代码。注意，这里设置用户签名和将来登录GitHub（或其他代码托管中心）的账号没有任何关系。

设置签名的基本语法如下：

- `git config --global user.name [用户名]`。
- `git config --global user.email [邮箱]`。

如果提供了`--global`参数，则设置签名是系统用户级别的（例如登录Windows系统的用户）；没有该参数则设置的签名是项目级别（或仓库级别）的，即用户名或Email地址在当前本地库有效。项目级别优先于系统用户级别，二者都有时，采用项目级别的签名。不允许两者都没有。

项目级别的信息保存在项目的.git/config文件夹下，系统用户级别的信息保存在用户目录的.gitconfig（隐藏）文件下。

## 初始化本地库

本地库初始化（建本地库）的基本语法为`git init`，该命令会在当前目录下创建`.git`（隐藏）目录。

## 查看本地库状态

查看本地库状态的基本语法为`git status`，这会显示当前所在分支、有无提交、是否有未追踪的文件以及有无需要提交的文件等信息。

## 添加暂存区

添加工作区的文件到暂存区的基本语法为`git add [文件名]`。此时查看本地库状态会发现Git检测到暂存区有新文件。

如果要删除暂存区中的文件，则可以使用基本语法`git rm --cached [文件名]`，注意它不会删除工作区中的文件。此时查看本地库状态会显示该文件未追踪。

## 提交本地库

提交暂存区的文件到本地库的基本语法为`git commit -m "[日志信息]" [文件名]`（或者不指定`-m "[日志信息]"`，在编辑器中输入信息，且安装时Git默认使用的编辑器决定了提交信息使用的编辑器）。如果所有文件都被提交，则查看本地库状态会显示没有需要提交的文件。提交会显示（精简）版本号。

文件被提交后如果被修改，则查看本地库状态会显示文件修改未添加到暂存区（未追踪），需要再次将其添加到暂存区、提交本地库。Git以行为单位维护文件，因此对于修改行，会显示一行新增、一行删除。

## 历史版本

### 查看历史版本

查看历史版本的基本语法如下：

- `git relog`：查看版本信息，包括项目经历过多少版本更替、每个版本的（精简）版本号、指针指向哪个版本等。
- `git log`：查看版本详细信息：还包括提交作者、提交日期、每个版本的（详细）版本号等。

### 版本穿梭

Git切换版本，底层其实是移动的HEAD指针。HEAD指针指向当前分支，而当前分支又指向当前版本。

版本穿梭的基本语法为：`git reset --hard [版本号]`。此时查看版本信息可以看到指针指向了目标版本，此时文件中的内容回退到该版本下的内容。

.git目录下的HEAD文件记录了指针指向的分支，而指针指向的版本号（即分支指向的版本）则记录在以该分支为路径的文件中。

# Git分支操作

在版本控制过程中，同时推进多个任务，为每个任务，我们就可以创建每个任务的单独分支。使用分支意味着程序员可以把自己的工作从开发主线上分离开来，开发自己分支的时候，不会影响主线分支的运行。

分支的好处在于：

- 同时并行推进多个功能开发，提高开发效率。
- 各个分支在开发过程中，如果某一个分支开发失败，不会对其他分支有任何影响。失败的分支删除重新开始即可。

分支底层其实也是指针的引用。当创建了master与hot-fix分支，master与hot-fix其实都是指向具体版本记录的指针。当前所在分支是由HEAD指针决定的。所以创建分支的本质就是多创建一个指针。HEAD如果指向master，那么我们现在就在master分支上；HEAD 如果执行hot-fix，那么我们现在就在hot-fix分支上。所以切换分支的本质就是移动HEAD指针。

## 查看分支

查看分支的基本语法为`git branch -v`。

## 创建分支

创建分支的基本语法为`git branch [分支名]`。此时查看分支会多出一个分支。

## 切换分支

切换分支的基本语法为`git checkout [分支名]`。

## 合并分支

合并分支的基本语法为`git merge [分支名]`，这会将指定分支合并到当前分支（合并分支只会修改当前分支，不会修改指定分支）。

合并分支时，如果两个分支对同一个文件执行不同的修改，则Git无法替我们决定使用哪一个，此时发生合并冲突，必须人为决定新代码内容。例如，如果分支A修改文件的第1行并提交，分支B修改同一文件的第2行并提交，此时分支A合并分支B会产生冲突。

冲突产生的表现在于Git Bash会显示其后的状态为`MERGING`。此时通过`git status`命令可以查看到文件的冲突信息。

有冲突的文件中的特殊符号表名冲突信息：`<<<<<<< HEAD`指示当前分支的代码，`>>>>>>> hot-fix`指示合并过来的代码，`=======`是两者的分隔。要想解决冲突，只要将文件修改到所需状态，并重新将该冲突文件添加到暂存区并提交到本地库（提交时不能带文件名）。

# Git团队协作机制

Git团队协作机制要用到代码托管中心。

## 团队内协作

本地库通过`push`操作将代码推送到远程库（前提是推送者必须加入远程库的团队）；本地库通过`clone`操作将代码克隆到本地；本地库通过`pull`操作拉取远程库的修改。

例如，A创建了远程库，并将代码`push`到代码托管中心的远程库，B将代码`clone`到其本地，且A将B加到自己的团队中，此时A可以将修改信息`push`到远程库，最后A将B修改后的代码`pull`到其本地。

## 跨团队协作

团队外的人通过`fork`操作复制出原始远程库的一个新远程库（两个远程库的区别在于属于不同的人或团队），并在该远程库上执行`clone`、`push`等操作（就像团队内协作那样）。然后通过`pull request`请求原始远程库团队审核，原始团队审核通过则使用`merge`操作合并新远程库到原始远程库，此时可以通过`pull`等操作将代码拉取到本地（就像团队内协作那样）。

## 远程仓库操作

下面以GitHub为例，演示使用远程仓库进行团队协作。

登录GitHub（或其他代码托管中心，操作有所不同），创建远程库。远程库创建完毕，会显示远程库的链接（HTTPS或SSH链接）。

### 创建远程仓库别名

创建远程仓库别名的基本语法为`git remote add [别名] [远程地址]`。

查看当前所有远程地址别名的基本语法为`git remote -v`。针对每个被创建的别名，查看别名会显示两个别名，分别用于`fetch`与`push`。

### 推送本地分支到远程仓库

推送本地分支到远程仓库的基本语法为`git push [别名/远程地址] [分支]`。

将本地库代码推送到远程库时，如果本地库代码跟远程库代码版本不一致，推送操作是会被拒绝的。也就是说，要想推送成功，一定要保证本地库的版本要比远程库的版本高。因此一个成熟的程序员在动手改本地代码之前，一定会先检查下远程库跟本地代码的区别。如果本地的代码版本已经落后，切记要先拉取一下远程库的代码，将本地代码更新到最新以后，然后再修改，提交，推送。

### 克隆远程仓库到本地

克隆远程仓库到本地的基本语法为`git clone [远程地址]`。克隆代码是不需要登录账号的。

克隆会做如下操作：

- 拉取代码。
- 初始化本地库。
- 创建别名`origin`（同样显示两个）。

拉取远端仓库代码到本地时，如果远程库代码和本地库代码不一致，会自动合并，如果自动合并失败，需要手动解决冲突。

### 拉取远程库内容

拉取远程库内容的基本语法为`git pull [别名/远程地址] [远程分支]`。

### 团队内协作

在GitHub中，访问https://github.com/username/repository/settings/access（假设用户名为username，仓库为repository），尝试邀请合作者。这会生成一个邀请函（Pending Invite），将该邀请函发送给目标用户，目标用户登录自己的GitHub账号并访问该邀请函地址，选择接受或拒绝加入团队。一旦接受，则目标用户就能看到请求者的当前远程库。此时目标用户就可以克隆、推送、拉取该远程库了。

### 跨团队协作

将远程仓库的地址发给受邀请跨团队协作的人（或者受邀请跨团队协作的人搜索当前远程仓库并获取其地址），然后此人登录自己的GitHub账号并访问该地址，然后点击Fork将项目克隆到自己的本地仓库，成功后可以看到当前仓库信息。

当此人修改好本地仓库的内容后（可以克隆本地库随后推送到GitHub，也可以在线编辑并提交），访问https://github.com/forked-username/forked-repository/pulls，创建推送请求。原始团队查看其远程仓库就能看到有该Pull requests请求，点击并进入聊天室，可以讨论代码相关内容。如果代码没有问题，则合并代码。

### SSH免密登录

远程仓库中除了HTTPS地址外，还有一个SSH地址。如果要使用SSH访问，则需要执行下列步骤：

- 进入用户目录，删除.ssh目录（如果存在的话），运行命令生成.ssh密钥目录：

  ```bash
  ssh-keygen -t rsa -C example
  ```

  其中，`-t`指定加密算法，`-C`指定描述信息。

- 登录GitHub账号，访问https://github.com/settings/keys，将以上生成的公钥（.ssh目录下的id_ras.pub文件中的内容）作为SSH key填入。此时系统连接GitHub账号（例如向远程仓库`push`代码）的时候使用SSH连接就不需要登录了。

# IDEA集成Git

## 配置Git忽略文件

有些文件与项目的实际功能无关，不参与服务器上部署运行。把它们忽略掉能够屏蔽IDE工具之间的差异。

要想忽略这些文件，需要创建忽略规则文件xxx.ignore（前缀名任意，建议是git.ignore）。原则上这个文件存放位置任意，但是为了便于让用户目录下的.gitconfig文件应用，建议放在用户目录下。

git.ignore文件中每行指定忽略文件（或文件夹）的模式，其中`*`表示任意字符。以`#`开头的行被忽略。

在用户目录下的.gitconfig文件中引用忽略配置文件，示例如下：

```
[user]
name = xxx
email = xxx
[core]
excludesfile = C:/Users/xxx/git.ignore
```

其中`[user]`的`name`与`email`指定用户签名，`[core]`的`excludesfile`指定忽略文件路径。

注意：这两个文件中，路径分隔符要使用`/`，不要使用`\`。

## 定位Git程序

点击File$\rightarrow$Settings，选择Version Control$\rightarrow$Git，配置Git的安装目录（Git\bin\git.exe）。当然，也可以让IDEA自动检测。

## 集成GitHub

如果要连接GitHub远程库，则需要执行以下操作：

- 下载GitHub插件。

- 点击File$\rightarrow$Settings，选择Version Control$\rightarrow$GitHub，添加GitHub账号。如果要使用口令登录，则进入[Personal access tokens](https://github.com/settings/tokens)生成新的口令。

IDEA同样可以集成Gitee与GitLab（需要先搭建GitLab服务），操作基本一致（同样需要下载对应的插件并添加账号）。

## 初始化本地库

VCS菜单下提供了版本控制的相关操作，点击Enable Version Control Integration或点击VCS Operations$\rightarrow$Create Git Repository并选择要创建Git本地仓库的工程等）。

## Git操作

通过以下以下方式可以查看版本控制信息、进行版本控制操作（包括添加文件或文件夹到暂存区、提交文件或文件夹到本地库、切换版本、创建分支、切换分支、合并分支、解决冲突，以及分享工程到GitHub、推送本地库到远程库以及拉取远程库到本地库等）：

- 右键点击项目、要添加的目录或要添加的文件，选择Git进行相关操作。
- 在工具窗口的Git$\rightarrow$Log中可以查看或操作版本信息。
- 右下角显示了Git分支相关信息与操作。
- 导航栏显示了提交、推送、历史记录等信息与操作。
- VCS（或Git）菜单也提供了Git相关操作。
- 在IDEA开始界面，点击”Get from VCS“，从远程库获取代码、创建项目。

可以HTTPS或SSH地址与远程库交互。

# 参考

[^1]: [尚硅谷Git入门到精通全套教程（涵盖GitHub\Gitee码云\GitLab）](https://www.bilibili.com/video/BV1vy4y1s7k6)
[^1]: [尚硅谷Git、GitHub、Gitee码云、GitLab（IDEA版本）](https://pan.baidu.com/s/1vAZoF2hxEnna5DfyYGyO4A#list/path=%2F)，提取码：xd8z
[^2]: [【尚硅谷】Git与GitHub基础全套完整版教程（快速上手，一套搞定）](https://www.bilibili.com/video/av24441039)
[^2]: [Git&github学习资料](https://pan.baidu.com/s/1wY4L8HHK38RInfGXtb2GGA#list/path=%2F)，提取码：ug1v
[^3]: [从零开始学习 Git 之 Git 的历史](https://blog.csdn.net/yang_z_1/article/details/122058020)
